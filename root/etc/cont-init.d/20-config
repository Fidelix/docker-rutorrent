#!/usr/bin/with-contenv bash

# make folders
mkdir -p \
	/config{/log/nginx,/log/rtorrent,/log/rutorrent,/nginx,/php,/rtorrent/rtorrent_sess,/rutorrent/settings/users} \
	/config/rutorrent/profiles{/settings,/torrents,/users,/tmp} \
	/downloads{/completed,/incoming,/watched} \
	/run{/nginx,/php} \
	/var/lib/nginx/tmp/client_body \
	/var/tmp/nginx


# copy config
PREV_DIR=$(pwd)

cd /defaults/rutorrent-conf || exit
	shopt -s globstar nullglob
	for i in *
	do
		[[ ! -e "/config/rutorrent/settings/${i}" ]] && cp -v "${i}" "/config/rutorrent/settings/${i}"
	done

cd "${PREV_DIR}" || exit

[[ ! -e /config/nginx/nginx.conf ]] && \
	cp /defaults/nginx.conf /config/nginx/nginx.conf


[[ ! -e /config/rtorrent/rtorrent.rc ]] && \
	cp /defaults/rtorrent.rc /config/rtorrent/rtorrent.rc
cp -pr /config/rutorrent/settings/* /usr/share/webapps/rutorrent/conf/

if [ ! -e "/config/php/php.ini" ]; then
	cp /etc/php7/php.ini /config/php/php.ini
	sed -i -e 's/\(register_argc_argv .*=\).*/\1 On/g' /config/php/php.ini
fi

cp /config/php/php.ini /etc/php7/php.ini

# create symlink for webui files
[[ ! -e /var/www/localhost/rutorrent ]] && ln -s \
/usr/share/webapps/rutorrent /var/www/localhost/rutorrent

## Add custom themes
[ "$(ls /config/custom_themes/)" ] && for theme in $(ls /config/custom_themes); do
    if [ ! -d /usr/share/webapps/rutorrent/plugins/theme/themes/${theme} ]; then
        ln -s /config/custom_themes/${theme} /usr/share/webapps/rutorrent/plugins/theme/themes/${theme}
    fi
done

## Add custom plugins
[ "$(ls /config/custom_plugins/)" ] && for custom_plugin in $(ls /config/custom_plugins); do
    if [ ! -d /usr/share/webapps/rutorrent/plugins/${plugin} ]; then
        ln -s /config/custom_plugins/${plugin} /usr/share/webapps/rutorrent/plugins/${plugin}
    fi
done

# plugins... place your themes in: /config/plugins
# requires restart to refresh
find /usr/share/webapps/rutorrent/plugins/theme/themes/ \
  -mindepth 1 -maxdepth 1 -type l -exec rm {} +
for i in $(ls -1 /config/themes)
do
    ln -s "/config/themes/$i" \
          "/usr/share/webapps/rutorrent/plugins/theme/themes/$i"
done

# delete lock file if exists
[[ -e /config/rtorrent/rtorrent_sess/rtorrent.lock ]] && \
	rm /config/rtorrent/rtorrent_sess/rtorrent.lock

# permissions
chown abc:abc \
	/downloads \
	/downloads{/completed,/incoming,/watched}

chown -R abc:abc \
	/config \
	/run \
	/usr/share/webapps/rutorrent \
	/var/lib/nginx \
	/var/tmp/nginx \
	/var/www/localhost/rutorrent

chmod -R 755 /config/rutorrent/profiles
chmod 644 /etc/logrotate.d/*
